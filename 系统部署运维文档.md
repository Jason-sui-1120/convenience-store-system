# 系统部署运维文档

> 便利店进销存系统部署和运维指南  
> 基于实际项目结构  
> 更新时间: 2025年1月8日  
> 版本: v1.0.0

## 🎯 系统架构概览

### 技术栈
- **前端**: Vue 3 + Vite + Element Plus
- **后端**: Node.js + Express.js
- **数据库**: Supabase PostgreSQL
- **测试环境**: Hono框架本地服务器
- **部署**: 支持多种部署方式

### 项目结构
```
ke/
├── frontend/           # 前端Vue应用
├── backend/           # 后端Express服务
├── edge-functions/    # 边缘函数和测试服务
├── docs/             # 文档目录
└── scripts/          # 部署脚本
```

## 🚀 环境准备

### 系统要求
- **Node.js**: >= 16.0.0
- **npm**: >= 8.0.0
- **操作系统**: macOS/Linux/Windows
- **内存**: >= 4GB
- **磁盘空间**: >= 2GB

### 依赖安装

**1. 安装Node.js和npm**
```bash
# macOS (使用Homebrew)
brew install node

# 验证安装
node --version
npm --version
```

**2. 克隆项目**
```bash
git clone <repository-url>
cd ke
```

**3. 安装项目依赖**
```bash
# 前端依赖
cd frontend
npm install

# 后端依赖
cd ../backend
npm install

# 边缘函数依赖
cd ../edge-functions
npm install
```

## 🔧 环境配置

### 环境变量配置

**1. 后端环境变量 (.env)**
```bash
# backend/.env
SUPABASE_URL=https://nxogjfzasogjzbkpfwle.supabase.co
SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
PORT=3000
NODE_ENV=production
```

**2. 前端环境变量 (.env)**
```bash
# frontend/.env
VITE_API_BASE_URL=http://localhost:3001
VITE_SUPABASE_URL=https://nxogjfzasogjzbkpfwle.supabase.co
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

**3. 测试环境变量**
```bash
# edge-functions/.env
PORT=3001
NODE_ENV=development
```

### Supabase配置

**1. 数据库连接**
- 确保Supabase项目已创建
- 获取项目URL和API密钥
- 配置数据库表结构（参考数据库设计文档）

**2. 安全设置**
```sql
-- 启用行级安全（RLS）
ALTER TABLE suppliers ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE inbound_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE outbound_records ENABLE ROW LEVEL SECURITY;

-- 创建基本访问策略
CREATE POLICY "Enable read access for all users" ON suppliers FOR SELECT USING (true);
CREATE POLICY "Enable insert access for all users" ON suppliers FOR INSERT WITH CHECK (true);
CREATE POLICY "Enable update access for all users" ON suppliers FOR UPDATE USING (true);
CREATE POLICY "Enable delete access for all users" ON suppliers FOR DELETE USING (true);
```

## 🏗️ 开发环境部署

### 本地开发启动

**1. 启动测试后端服务**
```bash
cd edge-functions
node test-local.js
```
- 服务地址: `http://localhost:3001`
- 提供模拟数据和API接口
- 支持热重载和调试

**2. 启动前端开发服务**
```bash
cd frontend
npm run dev
```
- 服务地址: `http://localhost:5174`
- 支持热重载
- 自动代理API请求

**3. 启动生产后端服务（可选）**
```bash
cd backend
npm start
```
- 服务地址: `http://localhost:3000`
- 连接真实Supabase数据库

### 开发工具配置

**1. VS Code配置**
```json
// .vscode/settings.json
{
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "files.associations": {
    "*.vue": "vue"
  }
}
```

**2. ESLint配置**
```javascript
// .eslintrc.js
module.exports = {
  env: {
    browser: true,
    es2021: true,
    node: true
  },
  extends: [
    'eslint:recommended',
    '@vue/eslint-config-prettier'
  ],
  rules: {
    'no-console': 'warn',
    'no-debugger': 'warn'
  }
}
```

## 🌐 生产环境部署

### 前端部署

**1. 构建前端应用**
```bash
cd frontend
npm run build
```

**2. 部署到静态托管**
```bash
# 部署到Vercel
npm install -g vercel
vercel --prod

# 部署到Netlify
npm install -g netlify-cli
netlify deploy --prod --dir=dist
```

**3. Nginx配置（自托管）**
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        root /var/www/html/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 后端部署

**1. PM2部署（推荐）**
```bash
# 安装PM2
npm install -g pm2

# 创建PM2配置文件
# ecosystem.config.js
module.exports = {
  apps: [{
    name: 'inventory-backend',
    script: './backend/server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log'
  }]
};

# 启动应用
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

**2. Docker部署**
```dockerfile
# Dockerfile
FROM node:16-alpine

WORKDIR /app

# 复制package.json
COPY backend/package*.json ./
RUN npm ci --only=production

# 复制源代码
COPY backend/ .

EXPOSE 3000

CMD ["node", "server.js"]
```

```bash
# 构建和运行
docker build -t inventory-backend .
docker run -d -p 3000:3000 --env-file .env inventory-backend
```

**3. 云服务部署**

**Railway部署**:
```bash
# 安装Railway CLI
npm install -g @railway/cli

# 登录和部署
railway login
railway init
railway up
```

**Render部署**:
- 连接GitHub仓库
- 设置构建命令: `cd backend && npm install`
- 设置启动命令: `cd backend && npm start`
- 配置环境变量

## 📊 监控和日志

### 应用监控

**1. PM2监控**
```bash
# 查看应用状态
pm2 status

# 查看日志
pm2 logs

# 监控面板
pm2 monit

# 重启应用
pm2 restart all
```

**2. 健康检查**
```bash
# 检查后端服务
curl http://localhost:3000/health

# 检查前端服务
curl http://localhost:5174
```

### 日志管理

**1. 日志配置**
```javascript
// backend/utils/logger.js
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' })
  ]
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}

module.exports = logger;
```

**2. 日志轮转**
```bash
# 安装logrotate
sudo apt-get install logrotate

# 配置文件 /etc/logrotate.d/inventory-app
/var/www/inventory/logs/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        pm2 reloadLogs
    endscript
}
```

## 🔒 安全配置

### HTTPS配置

**1. Let's Encrypt证书**
```bash
# 安装Certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
0 12 * * * /usr/bin/certbot renew --quiet
```

**2. 安全头配置**
```javascript
// backend/middleware/security.js
const helmet = require('helmet');

app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"]
    }
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));
```

### 数据库安全

**1. 连接安全**
```javascript
// 使用连接池
const { Pool } = require('pg');
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});
```

**2. 参数化查询**
```javascript
// 防止SQL注入
const getProducts = async (category) => {
  const query = 'SELECT * FROM products WHERE category = $1';
  const result = await pool.query(query, [category]);
  return result.rows;
};
```

## 🔧 维护操作

### 定期维护

**1. 数据库维护**
```sql
-- 清理过期数据
DELETE FROM outbound_records WHERE created_at < NOW() - INTERVAL '1 year';

-- 更新统计信息
ANALYZE;

-- 重建索引
REINDEX DATABASE your_database;
```

**2. 日志清理**
```bash
#!/bin/bash
# cleanup.sh
find /var/www/inventory/logs -name "*.log" -mtime +30 -delete
pm2 flush
```

**3. 备份脚本**
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups"

# 数据库备份
pg_dump $DATABASE_URL > $BACKUP_DIR/db_backup_$DATE.sql

# 应用备份
tar -czf $BACKUP_DIR/app_backup_$DATE.tar.gz /var/www/inventory

# 清理旧备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
```

### 故障排除

**1. 常见问题**

**服务无法启动**:
```bash
# 检查端口占用
lsof -i :3000

# 检查进程状态
ps aux | grep node

# 查看错误日志
pm2 logs --err
```

**数据库连接失败**:
```bash
# 测试数据库连接
psql $DATABASE_URL

# 检查网络连接
ping your-supabase-host.com

# 验证环境变量
echo $SUPABASE_URL
```

**前端页面无法加载**:
```bash
# 检查构建文件
ls -la frontend/dist/

# 检查Nginx配置
nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

**2. 性能优化**

**数据库优化**:
```sql
-- 查看慢查询
SELECT query, mean_time, calls 
FROM pg_stat_statements 
ORDER BY mean_time DESC 
LIMIT 10;

-- 添加索引
CREATE INDEX CONCURRENTLY idx_products_category_stock 
ON products(category, currentStock);
```

**应用优化**:
```javascript
// 启用压缩
const compression = require('compression');
app.use(compression());

// 缓存静态资源
app.use(express.static('public', {
  maxAge: '1d',
  etag: true
}));
```

## 📈 扩展部署

### 负载均衡

**1. Nginx负载均衡**
```nginx
upstream backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}

server {
    location /api {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**2. 多实例部署**
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'inventory-backend',
    script: './backend/server.js',
    instances: 4,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production'
    }
  }]
};
```

### 容器化部署

**1. Docker Compose**
```yaml
# docker-compose.yml
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
  
  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
    volumes:
      - ./logs:/app/logs
  
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
```

**2. Kubernetes部署**
```yaml
# k8s-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: inventory-backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: inventory-backend
  template:
    metadata:
      labels:
        app: inventory-backend
    spec:
      containers:
      - name: backend
        image: inventory-backend:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
```

## 📋 部署检查清单

### 部署前检查
- [ ] 环境变量配置完成
- [ ] 数据库连接测试通过
- [ ] 依赖包安装完成
- [ ] 构建过程无错误
- [ ] 安全配置已应用

### 部署后验证
- [ ] 服务启动正常
- [ ] API接口响应正常
- [ ] 前端页面加载正常
- [ ] 数据库操作正常
- [ ] 日志记录正常

### 监控设置
- [ ] 健康检查配置
- [ ] 错误监控设置
- [ ] 性能监控启用
- [ ] 备份计划执行
- [ ] 告警通知配置

---

**维护说明**: 本文档基于实际项目结构编写，涵盖了从开发到生产的完整部署流程。请根据实际环境调整配置参数，确保系统稳定运行。